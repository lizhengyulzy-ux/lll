<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>产供销联席会 - 交互版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#0891b2',
                        accent: '#f59e0b',
                        neutral: '#1f2937',
                        'neutral-light': '#6b7280',
                        'neutral-lighter': '#f3f4f6',
                    },
                    fontFamily: {
                        sans: ['Noto Sans SC', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 4px 12px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 20px rgba(0, 0, 0, 0.12)',
                    },
                },
            },
        };
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .bg-gradient-primary {
                background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
            }
            .card-hover {
                transition: all 0.2s ease;
            }
            .card-hover:hover {
                transform: translateY(-4px);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            }
        }
    </style>
</head>
<body class="bg-neutral-lighter font-sans text-neutral">
    <!-- 顶部导航 + 角色切换 -->
    <nav class="bg-white shadow-md fixed top-0 left-0 right-0 z-40">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="text-primary text-2xl font-bold">
                    <i class="fa fa-calendar-check-o"></i>
                </div>
                <div>
                    <h1 class="text-lg md:text-xl font-bold text-primary">产供销联席会</h1>
                    <p class="text-xs text-neutral-light hidden sm:block">日历 · 议程 · 待办 · 周报 · 议题申报 一体化看板</p>
                </div>
            </div>

            <!-- 角色切换 -->
            <div class="flex items-center space-x-3 text-sm">
                <span class="text-neutral-light hidden md:inline">当前角色：</span>
                <select
                    id="roleSelect"
                    class="border border-neutral-light rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-primary/40"
                >
                    <option value="admin">管理员</option>
                    <option value="member">联席会委员</option>
                    <option value="group">一级工作组成员</option>
                </select>
                <span
                    id="roleBadge"
                    class="px-2 py-1 rounded-full text-xs bg-primary/10 text-primary flex items-center space-x-1"
                >
                    <i class="fa fa-shield"></i>
                    <span>管理员</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- 顶部介绍 -->
    <section class="bg-gradient-primary pt-24 pb-8 md:pb-12 px-4">
        <div class="container mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div class="text-white max-w-xl">
                <h2 class="text-2xl md:text-3xl font-bold mb-3">产供销联席会协同工作台</h2>
                <p class="text-white/90 text-sm md:text-base mb-4">
                    围绕会议日历，集中管理会议议程、待办追踪、周报与议题申报，实现“会前准备、会中决策、会后落实”的闭环。
                </p>
            </div>
        </div>
    </section>

    <!-- 主体布局：左侧日历 + 右侧六大模块 -->
    <main class="container mx-auto px-4 py-6 md:py-10 grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
        <!-- 左侧：会议日历 -->
        <section class="lg:col-span-1 bg-white rounded-xl shadow-card p-4 md:p-6">
            <div class="flex items-center justify-between mb-3 md:mb-4">
                <div>
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-calendar text-primary"></i>
                        <span>会议日历</span>
                    </h3>
                    <p class="text-xs text-neutral-light mt-1">点击某一天查看/维护该日会议及相关信息。</p>
                </div>
                <div class="flex items-center space-x-2 text-xs">
                    <button
                        id="prevMonthBtn"
                        class="border rounded-md px-2 py-1 hover:bg-neutral-lighter transition-colors"
                    >
                        <i class="fa fa-chevron-left"></i>
                    </button>
                    <div id="currentMonthLabel" class="font-medium min-w-[90px] text-center"></div>
                    <button
                        id="nextMonthBtn"
                        class="border rounded-md px-2 py-1 hover:bg-neutral-lighter transition-colors"
                    >
                        <i class="fa fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 日历头 -->
            <div class="grid grid-cols-7 text-center text-[11px] md:text-xs text-neutral-light mb-2">
                <div>日</div>
                <div>一</div>
                <div>二</div>
                <div>三</div>
                <div>四</div>
                <div>五</div>
                <div>六</div>
            </div>

            <!-- 日历主体 -->
            <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-xs md:text-sm"></div>

            <!-- 选中日期信息 + 管理员会议编辑 -->
            <div class="mt-4 border-t pt-3">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <span class="text-xs text-neutral-light">当前选中日期：</span>
                        <span id="selectedDateLabel" class="text-sm font-medium text-primary"></span>
                    </div>
                    <span id="weekdayLabel" class="text-xs text-neutral-light"></span>
                </div>

                <div id="meetingList" class="space-y-2 max-h-40 overflow-y-auto text-xs md:text-sm"></div>

                <!-- 管理员编辑会议 -->
                <div id="adminMeetingForm" class="mt-3 space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-neutral-light">维护该日会议</span>
                        <button
                            id="addMeetingBtn"
                            class="text-xs px-2 py-1 rounded-md bg-primary text-white hover:bg-primary/90"
                        >
                            <i class="fa fa-plus mr-1"></i>新增会议
                        </button>
                    </div>
                    <div class="text-[11px] text-neutral-light">
                        可对选中日期的会议进行添加、修改、删除，仅管理员可编辑。
                    </div>
                </div>
            </div>
        </section>

        <!-- 右侧：六大联动模块（顺序：议程+议题申报 / 纪要+待办 / 周报+库存） -->
        <section class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
            <!-- 第一排：会议议程 -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-list-ul text-primary"></i>
                        <span>会议议程</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">与选中日期的会议关联</span>
                </div>

                <div id="agendaContainer" class="flex-1 overflow-y-auto text-xs md:text-sm space-y-3"></div>

                <!-- 管理员可编辑议程 -->
                <div
                    id="agendaEditPanel"
                    class="mt-3 border-t pt-3 text-[11px] md:text-xs text-neutral-light"
                >
                    <div class="flex items-center justify-between mb-2">
                        <span>管理员可在此维护当前会议的议程条目。</span>
                        <button
                            id="addAgendaItemBtn"
                            class="px-2 py-1 rounded-md bg-primary text-white text-[11px] hover:bg-primary/90"
                        >
                            <i class="fa fa-plus mr-1"></i>新增议程
                        </button>
                    </div>
                </div>
            </div>

            <!-- 第一排：议题申报 -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-commenting-o text-primary"></i>
                        <span>议题申报</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">委员/工作组成员可申报议题，管理员审批</span>
                </div>

                <!-- 申报表单（非管理员可见） -->
                <div id="topicFormContainer" class="mb-3 text-xs md:text-sm space-y-2">
                    <div class="text-[11px] md:text-xs text-neutral-light">
                        申报议题将关联到当前选中日期的会议；若当天暂无会议，系统会提示先由管理员在日历中创建会议。
                    </div>
                    <div class="space-y-2">
                        <input
                            id="topicTitleInput"
                            type="text"
                            placeholder="议题名称"
                            class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                        />
                        <textarea
                            id="topicDescInput"
                            rows="2"
                            placeholder="议题简要说明"
                            class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                        ></textarea>
                        <button
                            id="submitTopicBtn"
                            class="px-3 py-1 rounded-md bg-secondary text-white text-[11px] hover:bg-secondary/90"
                        >
                            <i class="fa fa-paper-plane mr-1"></i>提交议题申报
                        </button>
                    </div>
                </div>

                <!-- 当前角色申报记录 -->
                <div class="flex-1 flex flex-col border-t pt-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs text-neutral-light">当前角色的议题申报记录</span>
                        <select
                            id="topicStatusFilter"
                            class="border border-neutral-light rounded-md px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-primary/40"
                        >
                            <option value="all">全部状态</option>
                            <option value="pending">审批中</option>
                            <option value="approved">已通过</option>
                            <option value="rejected">已退回</option>
                        </select>
                    </div>
                    <div id="topicList" class="flex-1 overflow-y-auto text-xs md:text-sm space-y-2"></div>
                </div>

                <!-- 管理员审批面板 -->
                <div
                    id="topicApprovePanel"
                    class="mt-3 border-t pt-3 text-[11px] md:text-xs text-neutral-light"
                >
                    <div class="flex items-center justify-between mb-2">
                        <span>管理员审批当前日期相关议题申报。</span>
                        <span class="text-[11px] text-neutral-light">点击“通过/退回”更新状态。</span>
                    </div>
                    <div id="topicApproveList" class="max-h-40 overflow-y-auto text-xs md:text-sm space-y-2"></div>
                </div>
            </div>

            <!-- 第二排：会议纪要 -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-book text-primary"></i>
                        <span>会议纪要</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">与选中日期的会议对应</span>
                </div>

                <div class="text-[11px] md:text-xs text-neutral-light mb-2">
                    针对每个会议维护“会议共识”和一个外部“会议纪要”链接（如：SharePoint、钉钉文档等）。
                </div>

                <div id="meetingMinutesContainer" class="flex-1 overflow-y-auto text-xs md:text-sm space-y-2"></div>
            </div>

            <!-- 第二排：待办追踪 -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-check-square-o text-primary"></i>
                        <span>待办追踪</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">来源：会议形成的行动项</span>
                </div>

                <div class="flex items-center gap-2 mb-2 text-[11px]">
                    <label>按状态：</label>
                    <select
                        id="taskStatusFilter"
                        class="border border-neutral-light rounded-md px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-primary/40"
                    >
                        <option value="all">全部</option>
                        <option value="pending">待完成</option>
                        <option value="doing">进行中</option>
                        <option value="done">已完成</option>
                    </select>
                </div>

                <div id="taskList" class="flex-1 overflow-y-auto text-xs md:text-sm space-y-2"></div>

                <!-- 管理员可编辑待办 -->
                <div
                    id="taskEditPanel"
                    class="mt-3 border-t pt-3 text-[11px] md:text-xs text-neutral-light"
                >
                    <div class="flex items-center justify-between mb-2">
                        <span>管理员可在此为当前会议维护待办任务。</span>
                        <button
                            id="addTaskBtn"
                            class="px-2 py-1 rounded-md bg-primary text-white text-[11px] hover:bg-primary/90"
                        >
                            <i class="fa fa-plus mr-1"></i>新增待办
                        </button>
                    </div>
                </div>
            </div>

            <!-- 第三排：周报（周五） -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-file-text-o text-primary"></i>
                        <span>周报（周五）</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">系统以每周五为周报日期</span>
                </div>

                <div class="text-[11px] md:text-xs text-neutral-light mb-2">
                    选中日期所属周的周五会被识别为周报日期，可为该周报维护一个外部链接及简要内容（如：SharePoint、钉钉文档等）。
                </div>

                <div id="weeklyReportInfo" class="text-xs md:text-sm space-y-2"></div>

                <!-- 管理员可编辑周报链接和内容 -->
                <div
                    id="weeklyReportEditPanel"
                    class="mt-3 border-t pt-3 text-[11px] md:text-xs text-neutral-light"
                >
                    <div class="space-y-2">
                        <label class="block">周报链接（URL）：</label>
                        <input
                            id="weeklyReportLinkInput"
                            type="url"
                            placeholder="例如：https://..."
                            class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                        />

                        <label class="block mt-2">周报内容：</label>
                        <textarea
                            id="weeklyReportContentInput"
                            rows="3"
                            placeholder="可简要记录本周关键事项、风险与决议要点..."
                            class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                        ></textarea>

                        <button
                            id="saveWeeklyReportBtn"
                            class="mt-1 px-3 py-1 rounded-md bg-primary text-white text-[11px] hover:bg-primary/90"
                        >
                            <i class="fa fa-save mr-1"></i>保存周报
                        </button>
                    </div>
                </div>
            </div>

            <!-- 第三排：端到端库存管理（周二） -->
            <div class="bg-white rounded-xl shadow-card p-4 md:p-6 flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-base md:text-lg font-semibold flex items-center space-x-2">
                        <i class="fa fa-cubes text-primary"></i>
                        <span>端到端库存管理</span>
                    </h3>
                    <span class="text-[11px] text-neutral-light">系统以每周二为库存看板日期</span>
                </div>

                <div class="text-[11px] md:text-xs text-neutral-light mb-2">
                    选中日期所属周的周二会被识别为库存看板日期，预留两个看板展示位：
                    <span class="font-medium">“端到端库存跟踪”</span> 与
                    <span class="font-medium">“零部件ITO情况”</span>。
                </div>

                <div id="inventoryBoardInfo" class="text-xs md:text-sm space-y-2"></div>

                <!-- 管理员可编辑库存看板链接 -->
                <div
                    id="inventoryBoardEditPanel"
                    class="mt-3 border-t pt-3 text-[11px] md:text-xs text-neutral-light"
                >
                    <div class="space-y-2">
                        <div>
                            <label class="block mb-1">端到端库存跟踪链接（URL）：</label>
                            <input
                                id="inventoryTrackingLinkInput"
                                type="url"
                                placeholder="例如：https://..."
                                class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                            />
                        </div>
                        <div>
                            <label class="block mb-1">零部件ITO情况链接（URL）：</label>
                            <input
                                id="inventoryItoLinkInput"
                                type="url"
                                placeholder="例如：https://..."
                                class="w-full border border-neutral-light rounded-md px-2 py-1 text-xs focus:outline-none focus:ring-1 focus:ring-primary/40"
                            />
                        </div>
                        <button
                            id="saveInventoryBoardBtn"
                            class="mt-1 px-3 py-1 rounded-md bg-primary text-white text-[11px] hover:bg-primary/90"
                        >
                            <i class="fa fa-save mr-1"></i>保存库存看板链接
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 简单弹窗模板（新增会议/编辑） -->
    <div
        id="dialogOverlay"
        class="fixed inset-0 bg-black/40 flex items-center justify-center z-50 hidden"
    >
        <div class="bg-white rounded-xl shadow-card w-[95%] max-w-md p-4 md:p-6 text-sm">
            <div class="flex items-center justify-between mb-3">
                <h3 id="dialogTitle" class="text-base md:text-lg font-semibold">编辑</h3>
                <button id="dialogCloseBtn" class="text-neutral-light hover:text-neutral">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="dialogBody" class="space-y-3 text-xs md:text-sm"></div>
            <div class="mt-4 flex justify-end space-x-2 text-xs">
                <button
                    id="dialogCancelBtn"
                    class="px-3 py-1 rounded-md border border-neutral-light hover:bg-neutral-lighter"
                >
                    取消
                </button>
                <button
                    id="dialogConfirmBtn"
                    class="px-3 py-1 rounded-md bg-primary text-white hover:bg-primary/90"
                >
                    确认
                </button>
            </div>
        </div>
    </div>

    <script>
        // ------------------ 数据模型 ------------------
        const BASE_YEAR = 2026;
        const BASE_MONTH = 0;
        const BASE_DAY = 1;

        const meetingsByDate = {};
        const agendasByMeeting = {};
        const tasksByMeeting = {};
        const meetingMinutesByMeeting = {};
        const weeklyReports = {};
        const inventoryBoardsByTuesday = {};
        const topics = [];

        let currentRole = 'admin';
        let currentDate = new Date(BASE_YEAR, BASE_MONTH, BASE_DAY);
        let selectedDate = new Date(BASE_YEAR, BASE_MONTH, BASE_DAY);

        const pad2 = (n) => (n < 10 ? '0' + n : '' + n);
        const formatDate = (d) => (typeof d === 'string' ? d : `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`);
        const getWeekdayName = (d) => ['周日','周一','周二','周三','周四','周五','周六'][(d instanceof Date ? d : new Date(d)).getDay()];

        function getFridayOfWeek(date) {
            const d = new Date(date);
            d.setDate(d.getDate() + (5 - d.getDay()));
            return formatDate(d);
        }

        function getTuesdayOfWeek(date) {
            const d = new Date(date);
            d.setDate(d.getDate() + (2 - d.getDay()));
            return formatDate(d);
        }

        function initSampleData() {
            const d1 = new Date(BASE_YEAR, 0, 15);
            const d2 = new Date(BASE_YEAR, 0, 22);
            const d1Str = formatDate(d1);
            const d2Str = formatDate(d2);

            meetingsByDate[d1Str] = [
                { id: 'm1', title: '月度产供销协调会议', time: '14:00-16:00', location: '会议室A' },
            ];
            meetingsByDate[d2Str] = [
                { id: 'm2', title: '季度总结与计划会议', time: '09:00-12:00', location: '会议室B' },
            ];

            agendasByMeeting['m1'] = [
                { id: 'a1', order: 1, title: '上月工作总结回顾', duration: '30min' },
                { id: 'a2', order: 2, title: '本月计划与目标确认', duration: '40min' },
            ];
            agendasByMeeting['m2'] = [
                { id: 'a3', order: 1, title: '季度工作总结', duration: '60min' },
            ];

            tasksByMeeting['m1'] = [
                { id: 't1', title: '调整生产计划以应对需求变化', owner: '生产部门', status: 'doing' },
                { id: 't2', title: '评估供应商绩效并优化采购策略', owner: '供应部门', status: 'pending' },
            ];
            tasksByMeeting['m2'] = [
                { id: 't3', title: '制定第二季度营销策略', owner: '销售部门', status: 'pending' },
            ];

            const friday = getFridayOfWeek(d1);
            weeklyReports[friday] = {
                link: 'https://example.com/report-demo',
                content: '本周关键工作小结示例：\n1. 完成1月产供销对齐；\n2. 核查重点物料供应风险；\n3. 更新下周交付风险清单。',
            };

            const tuesday = getTuesdayOfWeek(d1);
            inventoryBoardsByTuesday[tuesday] = {
                trackingLink: 'https://example.com/inventory-tracking-demo',
                itoLink: 'https://example.com/ito-demo',
            };

            topics.push(
                {
                    id: 'topic1',
                    role: 'member',
                    meetingId: 'm1',
                    date: d1Str,
                    title: '讨论关键物料安全库存策略',
                    desc: '针对A类物料提出更严格的安全库存策略建议。',
                    status: 'approved',
                    feedback: '建议纳入2026年一季度试运行。',
                },
                {
                    id: 'topic2',
                    role: 'group',
                    meetingId: 'm2',
                    date: d2Str,
                    title: '新品试生产资源保障',
                    desc: '请协调产线与供应资源，保障新品试生产。',
                    status: 'pending',
                    feedback: '',
                }
            );
        }

        // ------------------ DOM 引用 ------------------
        const roleSelect = document.getElementById('roleSelect');
        const roleBadge = document.getElementById('roleBadge');
        const currentMonthLabel = document.getElementById('currentMonthLabel');
        const calendarGrid = document.getElementById('calendarGrid');
        const selectedDateLabel = document.getElementById('selectedDateLabel');
        const weekdayLabel = document.getElementById('weekdayLabel');
        const meetingList = document.getElementById('meetingList');
        const adminMeetingForm = document.getElementById('adminMeetingForm');

        const agendaContainer = document.getElementById('agendaContainer');
        const agendaEditPanel = document.getElementById('agendaEditPanel');

        const taskStatusFilter = document.getElementById('taskStatusFilter');
        const taskList = document.getElementById('taskList');
        const taskEditPanel = document.getElementById('taskEditPanel');

        const weeklyReportInfo = document.getElementById('weeklyReportInfo');
        const weeklyReportEditPanel = document.getElementById('weeklyReportEditPanel');
        const weeklyReportLinkInput = document.getElementById('weeklyReportLinkInput');
        const weeklyReportContentInput = document.getElementById('weeklyReportContentInput');

        const meetingMinutesContainer = document.getElementById('meetingMinutesContainer');

        const inventoryBoardInfo = document.getElementById('inventoryBoardInfo');
        const inventoryBoardEditPanel = document.getElementById('inventoryBoardEditPanel');
        const inventoryTrackingLinkInput = document.getElementById('inventoryTrackingLinkInput');
        const inventoryItoLinkInput = document.getElementById('inventoryItoLinkInput');

        const topicFormContainer = document.getElementById('topicFormContainer');
        const topicTitleInput = document.getElementById('topicTitleInput');
        const topicDescInput = document.getElementById('topicDescInput');
        const topicStatusFilter = document.getElementById('topicStatusFilter');
        const topicList = document.getElementById('topicList');
        const topicApprovePanel = document.getElementById('topicApprovePanel');
        const topicApproveList = document.getElementById('topicApproveList');

        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const addMeetingBtn = document.getElementById('addMeetingBtn');
        const addAgendaItemBtn = document.getElementById('addAgendaItemBtn');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const saveWeeklyReportBtn = document.getElementById('saveWeeklyReportBtn');
        const saveInventoryBoardBtn = document.getElementById('saveInventoryBoardBtn');
        const submitTopicBtn = document.getElementById('submitTopicBtn');

        const dialogOverlay = document.getElementById('dialogOverlay');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogBody = document.getElementById('dialogBody');
        const dialogCloseBtn = document.getElementById('dialogCloseBtn');
        const dialogCancelBtn = document.getElementById('dialogCancelBtn');
        const dialogConfirmBtn = document.getElementById('dialogConfirmBtn');

        let dialogConfirmHandler = null;

        function openDialog({ title, bodyHtml, onConfirm }) {
            dialogTitle.textContent = title || '编辑';
            dialogBody.innerHTML = bodyHtml || '';
            dialogOverlay.classList.remove('hidden');
            dialogConfirmHandler = onConfirm || null;
        }

        function closeDialog() {
            dialogOverlay.classList.add('hidden');
            dialogBody.innerHTML = '';
            dialogConfirmHandler = null;
        }

        dialogCloseBtn.addEventListener('click', closeDialog);
        dialogCancelBtn.addEventListener('click', closeDialog);
        dialogConfirmBtn.addEventListener('click', () => {
            if (typeof dialogConfirmHandler === 'function') {
                const ok = dialogConfirmHandler();
                if (ok !== false) closeDialog();
            } else {
                closeDialog();
            }
        });

        // ------------------ 渲染逻辑 ------------------
        function renderRole() {
            const map = {
                admin: { label: '管理员', icon: 'fa-shield' },
                member: { label: '联席会委员', icon: 'fa-users' },
                group: { label: '一级工作组成员', icon: 'fa-sitemap' },
            };
            const info = map[currentRole];
            roleBadge.innerHTML = `<i class="fa ${info.icon} mr-1"></i><span>${info.label}</span>`;

            const isAdmin = currentRole === 'admin';
            adminMeetingForm.classList.toggle('hidden', !isAdmin);
            agendaEditPanel.classList.toggle('hidden', !isAdmin);
            taskEditPanel.classList.toggle('hidden', !isAdmin);
            weeklyReportEditPanel.classList.toggle('hidden', !isAdmin);
            inventoryBoardEditPanel.classList.toggle('hidden', !isAdmin);
            topicFormContainer.classList.toggle('hidden', isAdmin);
            topicApprovePanel.classList.toggle('hidden', !isAdmin);
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            currentMonthLabel.textContent = `${year}年${month + 1}月`;

            const firstDay = new Date(year, month, 1);
            const startWeekday = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            calendarGrid.innerHTML = '';

            for (let i = 0; i < startWeekday; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            const todayStr = formatDate(new Date());
            const selectedStr = formatDate(selectedDate);

            for (let day = 1; day <= daysInMonth; day++) {
                const d = new Date(year, month, day);
                const dStr = formatDate(d);
                const hasMeetings = Array.isArray(meetingsByDate[dStr]) && meetingsByDate[dStr].length > 0;

                const cell = document.createElement('button');
                cell.type = 'button';
                cell.textContent = day;
                cell.className = 'relative h-9 md:h-10 flex items-center justify-center rounded-md text-xs md:text-sm border border-transparent';

                if (dStr === selectedStr) {
                    cell.classList.add('bg-primary', 'text-white', 'font-semibold');
                } else if (dStr === todayStr) {
                    cell.classList.add('border-primary', 'bg-primary/5', 'font-medium');
                } else {
                    cell.classList.add('hover:bg-neutral-lighter');
                }

                if (hasMeetings) {
                    const dot = document.createElement('span');
                    dot.className = 'absolute bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-secondary';
                    cell.appendChild(dot);
                }

                if (d.getDay() === 0 || d.getDay() === 6) {
                    cell.classList.add('text-neutral-light');
                }

                cell.addEventListener('click', () => {
                    selectedDate = d;
                    renderCalendar();
                    renderAllPanels();
                });

                calendarGrid.appendChild(cell);
            }
        }

        function renderSelectedDateInfo() {
            const dateStr = formatDate(selectedDate);
            selectedDateLabel.textContent = dateStr;
            weekdayLabel.textContent = getWeekdayName(selectedDate);

            const meetings = meetingsByDate[dateStr] || [];
            meetingList.innerHTML = '';

            if (meetings.length === 0) {
                meetingList.innerHTML = '<div class="text-xs text-neutral-light">该日暂无会议。管理员可在下方新增会议。</div>';
                return;
            }

            meetings.forEach((m) => {
                const item = document.createElement('div');
                item.className = 'border rounded-md px-2 py-1 flex items-start justify-between gap-2 bg-neutral-lighter/40';
                item.innerHTML = `
                    <div>
                        <div class="text-xs font-semibold">${m.title}</div>
                        <div class="text-[11px] text-neutral-light">时间：${m.time || '-'} ｜ 地点：${m.location || '-'}</div>
                    </div>
                `;

                if (currentRole === 'admin') {
                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'flex flex-col gap-1 text-[11px]';

                    const editBtn = document.createElement('button');
                    editBtn.className = 'px-2 py-0.5 rounded-md bg-primary/10 text-primary hover:bg-primary/20';
                    editBtn.innerHTML = '<i class="fa fa-pencil"></i>';
                    editBtn.addEventListener('click', () => openMeetingDialog(dateStr, m));

                    const delBtn = document.createElement('button');
                    delBtn.className = 'px-2 py-0.5 rounded-md bg-red-50 text-red-500 hover:bg-red-100';
                    delBtn.innerHTML = '<i class="fa fa-trash"></i>';
                    delBtn.addEventListener('click', () => deleteMeeting(dateStr, m.id));

                    btnGroup.appendChild(editBtn);
                    btnGroup.appendChild(delBtn);
                    item.appendChild(btnGroup);
                }

                meetingList.appendChild(item);
            });
        }

        function openMeetingDialog(dateStr, meeting) {
            const isEdit = !!meeting;
            const title = isEdit ? '编辑会议' : '新增会议';
            const m = meeting || { title: '', time: '', location: '' };

            const bodyHtml = `
                <div class="space-y-2 text-xs">
                    <div>
                        <label class="block mb-1">日期：</label>
                        <input value="${dateStr}" disabled class="w-full border rounded-md px-2 py-1 bg-neutral-lighter text-neutral-light" />
                    </div>
                    <div>
                        <label class="block mb-1">会议名称：</label>
                        <input id="dlgMeetingTitle" value="${m.title || ''}" class="w-full border rounded-md px-2 py-1" />
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block mb-1">时间：</label>
                            <input id="dlgMeetingTime" value="${m.time || ''}" placeholder="如 14:00-16:00" class="w-full border rounded-md px-2 py-1" />
                        </div>
                        <div>
                            <label class="block mb-1">地点：</label>
                            <input id="dlgMeetingLocation" value="${m.location || ''}" class="w-full border rounded-md px-2 py-1" />
                        </div>
                    </div>
                </div>
            `;

            openDialog({
                title,
                bodyHtml,
                onConfirm: () => {
                    const titleInput = document.getElementById('dlgMeetingTitle');
                    const timeInput = document.getElementById('dlgMeetingTime');
                    const locInput = document.getElementById('dlgMeetingLocation');

                    const newTitle = titleInput.value.trim();
                    if (!newTitle) {
                        alert('请填写会议名称');
                        return false;
                    }

                    const list = meetingsByDate[dateStr] || [];
                    if (isEdit) {
                        meeting.title = newTitle;
                        meeting.time = timeInput.value.trim();
                        meeting.location = locInput.value.trim();
                    } else {
                        const id = 'm_' + Date.now();
                        list.push({ id, title: newTitle, time: timeInput.value.trim(), location: locInput.value.trim() });
                        meetingsByDate[dateStr] = list;
                    }
                    renderCalendar();
                    renderAllPanels();
                },
            });
        }

        function deleteMeeting(dateStr, meetingId) {
            if (!confirm('确定要删除该会议吗？会同时影响关联的议程、待办、纪要和议题。')) return;
            const list = meetingsByDate[dateStr] || [];
            meetingsByDate[dateStr] = list.filter((m) => m.id !== meetingId);

            delete agendasByMeeting[meetingId];
            delete tasksByMeeting[meetingId];
            delete meetingMinutesByMeeting[meetingId];
            for (let i = topics.length - 1; i >= 0; i--) {
                if (topics[i].meetingId === meetingId) topics.splice(i, 1);
            }

            renderCalendar();
            renderAllPanels();
        }

        function getSelectedMeetings() {
            const dateStr = formatDate(selectedDate);
            return meetingsByDate[dateStr] || [];
        }

        function renderAgenda() {
            agendaContainer.innerHTML = '';
            const meetings = getSelectedMeetings();

            if (meetings.length === 0) {
                agendaContainer.innerHTML = '<div class="text-xs text-neutral-light">当前日期暂无会议，因此没有对应议程。</div>';
                return;
            }

            meetings.forEach((m) => {
                const list = agendasByMeeting[m.id] || [];
                const card = document.createElement('div');
                card.className = 'border rounded-md p-2 mb-2 bg-neutral-lighter/40';
                card.innerHTML = `<div class="text-xs font-semibold mb-1">${m.title}</div>`;

                if (list.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'text-[11px] text-neutral-light';
                    empty.textContent = '暂无议程条目。';
                    card.appendChild(empty);
                } else {
                    list.slice().sort((a, b) => a.order - b.order).forEach((item) => {
                        const row = document.createElement('div');
                        row.className = 'flex items-center justify-between text-[11px] border-t pt-1 mt-1';
                        row.innerHTML = `
                            <div>
                                <span class="font-medium mr-1">${item.order}.</span>
                                <span>${item.title}</span>
                                ${item.duration ? `<span class="text-neutral-light ml-1">(${item.duration})</span>` : ''}
                            </div>
                        `;
                        if (currentRole === 'admin') {
                            const btn = document.createElement('button');
                            btn.className = 'px-2 py-0.5 rounded-md bg-primary/10 text-primary hover:bg-primary/20 ml-2';
                            btn.innerHTML = '<i class="fa fa-pencil"></i>';
                            btn.addEventListener('click', () => openAgendaDialog(m.id, item));
                            row.appendChild(btn);
                        }
                        card.appendChild(row);
                    });
                }

                agendaContainer.appendChild(card);
            });
        }

        function openAgendaDialog(meetingId, agendaItem) {
            const isEdit = !!agendaItem;
            const item = agendaItem || { order: '', title: '', duration: '' };

            const bodyHtml = `
                <div class="space-y-2 text-xs">
                    <div>
                        <label class="block mb-1">顺序编号：</label>
                        <input id="dlgAgendaOrder" value="${item.order || ''}" type="number" class="w-full border rounded-md px-2 py-1" />
                    </div>
                    <div>
                        <label class="block mb-1">议程标题：</label>
                        <input id="dlgAgendaTitle" value="${item.title || ''}" class="w-full border rounded-md px-2 py-1" />
                    </div>
                    <div>
                        <label class="block mb-1">时长说明：</label>
                        <input id="dlgAgendaDuration" value="${item.duration || ''}" placeholder="如 20min" class="w-full border rounded-md px-2 py-1" />
                    </div>
                </div>
            `;

            openDialog({
                title: isEdit ? '编辑议程条目' : '新增议程条目',
                bodyHtml,
                onConfirm: () => {
                    const orderInput = document.getElementById('dlgAgendaOrder');
                    const titleInput = document.getElementById('dlgAgendaTitle');
                    const durationInput = document.getElementById('dlgAgendaDuration');

                    const orderVal = parseInt(orderInput.value, 10) || 0;
                    const titleVal = titleInput.value.trim();
                    if (!titleVal) {
                        alert('请填写议程标题');
                        return false;
                    }

                    const list = agendasByMeeting[meetingId] || [];
                    if (isEdit) {
                        agendaItem.order = orderVal;
                        agendaItem.title = titleVal;
                        agendaItem.duration = durationInput.value.trim();
                    } else {
                        list.push({ id: 'a_' + Date.now(), order: orderVal, title: titleVal, duration: durationInput.value.trim() });
                        agendasByMeeting[meetingId] = list;
                    }
                    renderAgenda();
                },
            });
        }

        function renderMeetingMinutes() {
            if (!meetingMinutesContainer) return;
            meetingMinutesContainer.innerHTML = '';

            const meetings = getSelectedMeetings();
            if (meetings.length === 0) {
                meetingMinutesContainer.innerHTML = '<div class="text-xs text-neutral-light">当前日期暂无会议，因此没有对应会议纪要。</div>';
                return;
            }

            meetings.forEach((m) => {
                const minutes = meetingMinutesByMeeting[m.id] || { consensus: '', link: '' };
                const card = document.createElement('div');
                card.className = 'border rounded-md p-2 bg-neutral-lighter/40 text-xs space-y-1';

                const titleRow = document.createElement('div');
                titleRow.className = 'flex items-center justify-between';
                titleRow.innerHTML = `
                    <span class="font-semibold">${m.title}</span>
                    <span class="text-[11px] text-neutral-light">会议ID：${m.id}</span>
                `;
                card.appendChild(titleRow);

                const consensusRow = document.createElement('div');
                consensusRow.className = 'mt-1';
                consensusRow.innerHTML = `
                    <div class="text-[11px] text-neutral-light mb-0.5">会议共识：</div>
                    <div class="text-xs">${minutes.consensus ? minutes.consensus.replace(/\n/g,'<br/>') : '<span class="text-neutral-light">暂无会议共识内容。</span>'}</div>
                `;
                card.appendChild(consensusRow);

                const linkRow = document.createElement('div');
                linkRow.className = 'mt-1';
                if (minutes.link) {
                    const a = document.createElement('a');
                    a.href = minutes.link;
                    a.target = '_blank';
                    a.className = 'inline-flex items-center text-primary hover:underline break-all text-[11px]';
                    a.innerHTML = '<i class="fa fa-link mr-1"></i>会议纪要';
                    linkRow.appendChild(a);
                } else {
                    linkRow.innerHTML = '<span class="text-[11px] text-neutral-light">暂无会议纪要链接。</span>';
                }
                card.appendChild(linkRow);

                if (currentRole === 'admin') {
                    const btnRow = document.createElement('div');
                    btnRow.className = 'mt-2 flex items-center justify-end';
                    const editBtn = document.createElement('button');
                    editBtn.className = 'px-2 py-0.5 rounded-md bg-primary/10 text-primary hover:bg-primary/20 text-[11px]';
                    editBtn.innerHTML = '<i class="fa fa-pencil mr-1"></i>编辑纪要';
                    editBtn.addEventListener('click', () => openMeetingMinutesDialog(m.id));
                    btnRow.appendChild(editBtn);
                    card.appendChild(btnRow);
                }

                meetingMinutesContainer.appendChild(card);
            });
        }

        function openMeetingMinutesDialog(meetingId) {
            const minutes = meetingMinutesByMeeting[meetingId] || { consensus: '', link: '' };

            const bodyHtml = `
                <div class="space-y-2 text-xs">
                    <div>
                        <label class="block mb-1">会议共识：</label>
                        <textarea id="dlgMinutesConsensus" rows="4" class="w-full border rounded-md px-2 py-1">${minutes.consensus || ''}</textarea>
                    </div>
                    <div>
                        <label class="block mb-1">会议纪要链接（URL）：</label>
                        <input id="dlgMinutesLink" type="url" value="${minutes.link || ''}" placeholder="例如：https://..." class="w-full border rounded-md px-2 py-1" />
                    </div>
                </div>
            `;

            openDialog({
                title: '编辑会议纪要',
                bodyHtml,
                onConfirm: () => {
                    const consensusInput = document.getElementById('dlgMinutesConsensus');
                    const linkInput = document.getElementById('dlgMinutesLink');
                    const consensus = consensusInput.value.trim();
                    const link = linkInput.value.trim();

                    if (!consensus && !link) delete meetingMinutesByMeeting[meetingId];
                    else meetingMinutesByMeeting[meetingId] = { consensus, link };

                    renderMeetingMinutes();
                },
            });
        }

        function renderTasks() {
            taskList.innerHTML = '';
            const meetings = getSelectedMeetings();
            if (meetings.length === 0) {
                taskList.innerHTML = '<div class="text-xs text-neutral-light">当前日期暂无会议，因此没有对应的待办任务。</div>';
                return;
            }

            const statusFilter = taskStatusFilter.value;
            const allTasks = [];
            meetings.forEach((m) => {
                (tasksByMeeting[m.id] || []).forEach((task) => {
                    allTasks.push({ task, meetingTitle: m.title });
                });
            });

            const filtered = allTasks.filter(({ task }) => statusFilter === 'all' || task.status === statusFilter);
            if (filtered.length === 0) {
                taskList.innerHTML = '<div class="text-xs text-neutral-light">当前筛选条件下暂无任务。</div>';
                return;
            }

            const statusMap = {
                pending: { text: '待完成', cls: 'bg-primary/10 text-primary' },
                doing: { text: '进行中', cls: 'bg-secondary/10 text-secondary' },
                done: { text: '已完成', cls: 'bg-green-500/10 text-green-600' },
            };

            filtered.forEach(({ task, meetingTitle }) => {
                const t = task;
                const row = document.createElement('div');
                row.className = 'border rounded-md px-2 py-1 text-[11px] flex flex-col gap-1 bg-neutral-lighter/40';
                const s = statusMap[t.status] || statusMap.pending;
                row.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium">${t.title}</span>
                        <span class="task-status px-2 py-0.5 rounded-full text-[10px] ${s.cls}">${s.text}</span>
                    </div>
                    <div class="flex items-center justify-between text-neutral-light">
                        <span>责任部门：${t.owner || '-'}</span>
                        <span class="truncate max-w-[160px]">来源会议：${meetingTitle}</span>
                    </div>
                `;

                if (currentRole === 'admin') {
                    const statusEl = row.querySelector('.task-status');
                    statusEl.classList.add('cursor-pointer');
                    statusEl.title = '点击标记为已完成';
                    statusEl.addEventListener('click', () => {
                        t.status = 'done';
                        renderTasks();
                    });

                    const btnRow = document.createElement('div');
                    btnRow.className = 'flex items-center justify-end gap-1 mt-1';
                    ['pending', 'doing', 'done'].forEach((st) => {
                        const btn = document.createElement('button');
                        btn.className = 'px-2 py-0.5 rounded-md border border-neutral-light hover:bg-neutral-lighter text-[10px]';
                        btn.textContent = statusMap[st].text;
                        btn.addEventListener('click', () => {
                            t.status = st;
                            renderTasks();
                        });
                        btnRow.appendChild(btn);
                    });
                    row.appendChild(btnRow);
                }

                taskList.appendChild(row);
            });
        }

        function openTaskDialog(meetingId) {
            const bodyHtml = `
                <div class="space-y-2 text-xs">
                    <div>
                        <label class="block mb-1">任务名称：</label>
                        <input id="dlgTaskTitle" class="w-full border rounded-md px-2 py-1" />
                    </div>
                    <div>
                        <label class="block mb-1">责任部门/人：</label>
                        <input id="dlgTaskOwner" class="w-full border rounded-md px-2 py-1" />
                    </div>
                </div>
            `;

            openDialog({
                title: '新增待办任务',
                bodyHtml,
                onConfirm: () => {
                    const titleInput = document.getElementById('dlgTaskTitle');
                    const ownerInput = document.getElementById('dlgTaskOwner');
                    const title = titleInput.value.trim();
                    if (!title) {
                        alert('请填写任务名称');
                        return false;
                    }
                    const owner = ownerInput.value.trim();
                    const list = tasksByMeeting[meetingId] || [];
                    list.push({ id: 't_' + Date.now(), title, owner, status: 'pending' });
                    tasksByMeeting[meetingId] = list;
                    renderTasks();
                },
            });
        }

        function renderWeeklyReport() {
            const fridayStr = getFridayOfWeek(selectedDate);
            const info = weeklyReports[fridayStr];
            weeklyReportInfo.innerHTML = '';

            const textDiv = document.createElement('div');
            textDiv.className = 'text-xs space-y-2';
            textDiv.innerHTML = `
                <div>本周周报日期：<span class="font-medium text-primary">${fridayStr}</span>（周五）</div>
            `;

            if (info && info.link) {
                const link = document.createElement('a');
                link.href = info.link;
                link.target = '_blank';
                link.className = 'inline-flex items-center mt-1 text-primary hover:underline break-all text-xs';
                link.innerHTML = `<i class="fa fa-link mr-1"></i>周报链接：${info.link}`;
                textDiv.appendChild(link);
            } else {
                const span = document.createElement('div');
                span.className = 'text-[11px] text-neutral-light';
                span.textContent = '当前周暂无周报链接。';
                textDiv.appendChild(span);
            }

            const contentBlock = document.createElement('div');
            contentBlock.className = 'mt-2 p-2 rounded-md bg-neutral-lighter/60';
            contentBlock.innerHTML = `
                <div class="text-[11px] text-neutral-light mb-1">周报内容：</div>
                <div class="text-xs leading-snug">${
                    info && info.content
                        ? info.content.replace(/\n/g, '<br/>')
                        : '<span class="text-neutral-light">当前周暂无周报内容。</span>'
                }</div>
            `;
            textDiv.appendChild(contentBlock);

            weeklyReportInfo.appendChild(textDiv);

            if (currentRole === 'admin') {
                weeklyReportLinkInput.value = info && info.link ? info.link : '';
                weeklyReportContentInput.value = info && info.content ? info.content : '';
            }
        }

        function renderInventoryBoard() {
            if (!inventoryBoardInfo) return;
            inventoryBoardInfo.innerHTML = '';

            const tuesdayStr = getTuesdayOfWeek(selectedDate);
            const info = inventoryBoardsByTuesday[tuesdayStr];

            const wrap = document.createElement('div');
            wrap.className = 'text-xs space-y-2';

            const header = document.createElement('div');
            header.innerHTML = `本周库存看板日期：<span class="font-medium text-primary">${tuesdayStr}</span>（周二）`;
            wrap.appendChild(header);

            const trackingDiv = document.createElement('div');
            trackingDiv.innerHTML = '<div class="font-semibold mb-1">端到端库存跟踪</div>';
            if (info && info.trackingLink) {
                const a = document.createElement('a');
                a.href = info.trackingLink;
                a.target = '_blank';
                a.className = 'inline-flex items-center text-primary hover:underline break-all text-[11px]';
                a.innerHTML = '<i class="fa fa-external-link mr-1"></i>打开看板';
                trackingDiv.appendChild(a);
            } else {
                const span = document.createElement('span');
                span.className = 'text-[11px] text-neutral-light';
                span.textContent = '暂无链接，可由管理员在下方维护。';
                trackingDiv.appendChild(span);
            }
            wrap.appendChild(trackingDiv);

            const itoDiv = document.createElement('div');
            itoDiv.innerHTML = '<div class="font-semibold mb-1">零部件ITO情况</div>';
            if (info && info.itoLink) {
                const a = document.createElement('a');
                a.href = info.itoLink;
                a.target = '_blank';
                a.className = 'inline-flex items-center text-primary hover:underline break-all text-[11px]';
                a.innerHTML = '<i class="fa fa-external-link mr-1"></i>打开看板';
                itoDiv.appendChild(a);
            } else {
                const span = document.createElement('span');
                span.className = 'text-[11px] text-neutral-light';
                span.textContent = '暂无链接，可由管理员在下方维护。';
                itoDiv.appendChild(span);
            }
            wrap.appendChild(itoDiv);

            inventoryBoardInfo.appendChild(wrap);

            if (currentRole === 'admin') {
                const val = info || { trackingLink: '', itoLink: '' };
                inventoryTrackingLinkInput.value = val.trackingLink || '';
                inventoryItoLinkInput.value = val.itoLink || '';
            }
        }

        function renderTopicsForCurrentRole() {
            topicList.innerHTML = '';
            const statusFilter = topicStatusFilter.value;

            const list = topics.filter((t) => t.role === currentRole);
            const filtered = list.filter((t) => statusFilter === 'all' || t.status === statusFilter);

            if (filtered.length === 0) {
                topicList.innerHTML = '<div class="text-xs text-neutral-light">当前角色暂无申报记录或不符合筛选条件。</div>';
                return;
            }

            const statusMap = {
                pending: { text: '审批中', cls: 'bg-accent/10 text-accent' },
                approved: { text: '已通过', cls: 'bg-green-500/10 text-green-600' },
                rejected: { text: '已退回', cls: 'bg-red-500/10 text-red-600' },
            };

            filtered.forEach((t) => {
                const s = statusMap[t.status] || statusMap.pending;
                const row = document.createElement('div');
                row.className = 'border rounded-md px-2 py-1 bg-neutral-lighter/40 text-[11px]';
                row.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium">${t.title}</span>
                        <span class="task-status px-2 py-0.5 rounded-full text-[10px] ${s.cls}">${s.text}</span>
                    </div>
                    <div class="text-neutral-light flex items-center justify-between mt-1">
                        <span>关联日期：${t.date}</span>
                        <span class="truncate max-w-[150px]">会议ID：${t.meetingId}</span>
                    </div>
                    <div class="mt-1 text-neutral-light">说明：${t.desc || '-'}</div>
                    ${t.feedback ? `<div class="mt-1 text-green-800 text-[10px]">审批意见：${t.feedback}</div>` : ''}
                `;
                topicList.appendChild(row);
            });
        }

        function renderTopicsForApprove() {
            topicApproveList.innerHTML = '';
            if (currentRole !== 'admin') return;
            const dateStr = formatDate(selectedDate);
            const list = topics.filter((t) => t.date === dateStr);

            if (list.length === 0) {
                topicApproveList.innerHTML = '<div class="text-xs text-neutral-light">当前日期暂无议题申报。</div>';
                return;
            }

            const statusMap = {
                pending: { text: '审批中', cls: 'bg-accent/10 text-accent' },
                approved: { text: '已通过', cls: 'bg-green-500/10 text-green-600' },
                rejected: { text: '已退回', cls: 'bg-red-500/10 text-red-600' },
            };

            list.forEach((t) => {
                const s = statusMap[t.status] || statusMap.pending;
                const row = document.createElement('div');
                row.className = 'border rounded-md px-2 py-1 bg-neutral-lighter/40 text-[11px]';
                row.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-medium">${t.title}</span>
                        <span class="task-status px-2 py-0.5 rounded-full text-[10px] ${s.cls}">${s.text}</span>
                    </div>
                    <div class="mt-1 text-neutral-light flex items-center justify-between">
                        <span>申报角色：${t.role === 'member' ? '联席会委员' : t.role === 'group' ? '一级工作组成员' : t.role}</span>
                        <span class="truncate max-w-[150px]">关联日期：${t.date}</span>
                    </div>
                    <div class="mt-1 text-neutral-light">说明：${t.desc || '-'}</div>
                    ${t.feedback ? `<div class="mt-1 text-neutral-light text-[10px]">审批意见：${t.feedback}</div>` : ''}
                `;

                const btnRow = document.createElement('div');
                btnRow.className = 'flex items-center justify-end gap-2 mt-1';

                const approveBtn = document.createElement('button');
                approveBtn.className = 'px-2 py-0.5 rounded-md bg-green-500/10 text-green-700 hover:bg-green-500/20';
                approveBtn.innerHTML = '<i class="fa fa-check mr-1"></i>通过';
                approveBtn.addEventListener('click', () => updateTopicStatus(t, 'approved'));

                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'px-2 py-0.5 rounded-md bg-red-500/10 text-red-700 hover:bg-red-500/20';
                rejectBtn.innerHTML = '<i class="fa fa-ban mr-1"></i>退回';
                rejectBtn.addEventListener('click', () => updateTopicStatus(t, 'rejected'));

                btnRow.appendChild(approveBtn);
                btnRow.appendChild(rejectBtn);
                row.appendChild(btnRow);
                topicApproveList.appendChild(row);
            });
        }

        function updateTopicStatus(topic, status) {
            const opinion = prompt('请输入审批意见（可选）：', topic.feedback || '');
            topic.status = status;
            topic.feedback = opinion || '';
            renderTopicsForCurrentRole();
            renderTopicsForApprove();
        }

        function handleSubmitTopic() {
            if (currentRole === 'admin') return;
            const title = topicTitleInput.value.trim();
            const desc = topicDescInput.value.trim();
            if (!title) {
                alert('请填写议题名称');
                return;
            }
            const dateStr = formatDate(selectedDate);
            const meetings = meetingsByDate[dateStr] || [];
            if (meetings.length === 0) {
                alert('当前日期暂无会议，请联系管理员先在日历中创建会议。');
                return;
            }
            const meetingId = meetings[0].id;
            topics.push({ id: 'topic_' + Date.now(), role: currentRole, meetingId, date: dateStr, title, desc, status: 'pending', feedback: '' });
            topicTitleInput.value = '';
            topicDescInput.value = '';
            alert('已提交议题，等待管理员审批。');
            renderTopicsForCurrentRole();
            renderTopicsForApprove();
        }

        function renderAllPanels() {
            renderSelectedDateInfo();
            renderAgenda();
            renderMeetingMinutes();
            renderTasks();
            renderWeeklyReport();
            renderInventoryBoard();
            renderTopicsForCurrentRole();
            renderTopicsForApprove();
        }

        roleSelect.addEventListener('change', () => {
            currentRole = roleSelect.value;
            renderRole();
            renderAllPanels();
        });

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        addMeetingBtn.addEventListener('click', () => {
            const dateStr = formatDate(selectedDate);
            openMeetingDialog(dateStr, null);
        });

        addAgendaItemBtn.addEventListener('click', () => {
            const meetings = getSelectedMeetings();
            if (meetings.length === 0) {
                alert('当前日期暂无会议，请先新增会议。');
                return;
            }
            openAgendaDialog(meetings[0].id, null);
        });

        addTaskBtn.addEventListener('click', () => {
            const meetings = getSelectedMeetings();
            if (meetings.length === 0) {
                alert('当前日期暂无会议，请先新增会议。');
                return;
            }
            openTaskDialog(meetings[0].id);
        });

        saveWeeklyReportBtn.addEventListener('click', () => {
            const link = weeklyReportLinkInput.value.trim();
            const content = weeklyReportContentInput.value.trim();
            const fridayStr = getFridayOfWeek(selectedDate);

            if (!link && !content) {
                delete weeklyReports[fridayStr];
                renderWeeklyReport();
                return;
            }

            weeklyReports[fridayStr] = { link, content };
            alert('周报信息已保存');
            renderWeeklyReport();
        });

        saveInventoryBoardBtn.addEventListener('click', () => {
            const tuesdayStr = getTuesdayOfWeek(selectedDate);
            const trackingLink = inventoryTrackingLinkInput.value.trim();
            const itoLink = inventoryItoLinkInput.value.trim();

            if (!trackingLink && !itoLink) {
                delete inventoryBoardsByTuesday[tuesdayStr];
                renderInventoryBoard();
                return;
            }

            inventoryBoardsByTuesday[tuesdayStr] = { trackingLink, itoLink };
            alert('库存看板链接已保存');
            renderInventoryBoard();
        });

        submitTopicBtn.addEventListener('click', handleSubmitTopic);
        taskStatusFilter.addEventListener('change', renderTasks);
        topicStatusFilter.addEventListener('change', renderTopicsForCurrentRole);

        (function init() {
            initSampleData();
            currentDate = new Date(BASE_YEAR, BASE_MONTH, BASE_DAY);
            selectedDate = new Date(BASE_YEAR, BASE_MONTH, BASE_DAY);
            renderRole();
            renderCalendar();
            renderAllPanels();
        })();
    </script>
</body>
</html>
